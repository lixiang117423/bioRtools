% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pav_gwas.R
\name{pav_gwas}
\alias{pav_gwas}
\title{Enhanced Presence/Absence Variation (PAV) Genome-Wide Association Study (GWAS) Analysis}
\usage{
pav_gwas(
  pav_data,
  phenotype_data,
  output_dir = "pav_gwas_results",
  analysis_type = "auto",
  test_type = "auto",
  min_sample_count = 2,
  max_sample_count = NULL,
  binary_threshold = 0.5,
  use_population_structure = TRUE,
  n_pcs = 3,
  significance_threshold = NULL,
  n_cores = 4,
  verbose = TRUE
)
}
\arguments{
\item{pav_data}{Character string specifying the path to the PAV matrix file, 
or a data frame containing the PAV matrix. If a file path, the file should 
be tab-delimited with the following columns: 1) chr (chromosome), 2) start 
(start position), 3) end (end position), 4) sequence (PAV sequence), 
5+ sample abundance/presence values. Headers are expected.
If a data frame, it should follow the same column structure.}

\item{phenotype_data}{Character string specifying the path to the phenotype file, 
or a data frame containing phenotype information. If a file path, the file 
should be tab-delimited with sample IDs in the first column and phenotype 
values in the second column. Headers are expected. If a data frame, the first 
column should contain sample IDs and the second column should contain phenotype values.}

\item{output_dir}{Character string specifying the output directory for results. 
Default is "pav_gwas_results".}

\item{analysis_type}{Character string specifying the phenotype analysis approach. 
Options: "auto" (automatic detection), "binary", "logit", "arcsine", "categorical",
"continuous", "continuous_raw". Default is "auto".}

\item{test_type}{Character string specifying the statistical test method.
Options: "auto" (automatic selection), "fisher", "mannwhitney", "logistic",
"linear", "welch_ttest". Default is "auto".}

\item{min_sample_count}{Integer specifying the minimum number of samples where 
a PAV feature must be present to be included in analysis. Default is 2.}

\item{max_sample_count}{Integer specifying the maximum number of samples where 
a PAV feature can be present to be included in analysis. If NULL, uses total 
sample count (no upper limit). Default is NULL.}

\item{binary_threshold}{Numeric value specifying the threshold for binary 
conversion when analysis_type is "binary" or "auto". Default is 0.5.}

\item{use_population_structure}{Logical indicating whether to include population 
structure correction using PCA. Default is TRUE.}

\item{n_pcs}{Integer specifying the number of principal components to use for 
population structure correction. Default is 3.}

\item{significance_threshold}{Numeric value specifying the genome-wide significance 
threshold for Manhattan plot. If NULL (default), automatically calculates 
Bonferroni-corrected threshold as 0.05/number_of_tested_features. Can be 
manually specified if desired.}

\item{n_cores}{Integer specifying the number of CPU cores for parallel processing. 
Default is 4.}

\item{verbose}{Logical indicating whether to print progress information. 
Default is TRUE.}
}
\value{
A list containing:
\describe{
  \item{gwas_results}{Data frame with association test results including chromosomal positions (chr, start, end), sequence information, and statistical results for all PAV features.}
  \item{phenotype_stats}{Summary statistics of phenotype distribution.}
  \item{pca_results}{PCA results for population structure (if used).}
  \item{filtered_features}{Information about PAV feature filtering.}
  \item{analysis_summary}{Summary of analysis parameters and significant findings.}
  \item{threshold_results}{Data frame showing number of significant features at different p-value thresholds.}
}
}
\description{
Perform presence/absence variation based genome-wide association study using 
PAV data (such as k-mers, structural variants, gene presence/absence) and 
phenotype information. Enhanced version with better support for continuous 
phenotypes like plant height, weight, expression levels, etc.
}
\details{
**Enhanced Data Type Detection and Method Selection:**

The function automatically detects phenotype distribution patterns and selects 
appropriate statistical methods when analysis_type = "auto":

\enumerate{
  \item **Binary Data** (exactly 2 unique values): 
     - Automatically uses binary analysis
     - Uses Fisher's exact test for association
     - Ideal for case/control studies
  \item **Bimodal Distribution** (values concentrated at extremes): 
     - Automatically converts to binary phenotype
     - Uses Fisher's exact test for association
     - Ideal for presence/absence traits
  \item **Categorical Data** (3-10 discrete categories): 
     - Uses multinomial logistic regression
     - Falls back to chi-square test if logistic regression fails
     - Categories can be numeric or character
  \item **Continuous Data** (many unique values): 
     - **Normal Distribution**: Uses Welch's t-test for higher statistical power
     - **Non-normal Distribution**: Uses Mann-Whitney U test or applies transformations
     - **Bounded [0,1]**: Uses logit transformation
     - **Percentage-like [0,100]**: Uses arcsine transformation
  \item **Highly Skewed Continuous Data**: 
     - Uses log transformation or rank transformation
     - Followed by appropriate parametric/non-parametric tests
}

**Enhanced Manual Method Selection Guidelines:**

Choose specific methods based on your data characteristics:

- **analysis_type = "continuous"**: For truly continuous traits (plant height, 
  weight, expression levels). Automatically applies appropriate transformations.
- **analysis_type = "continuous_raw"**: For continuous traits without any 
  transformation. Uses raw phenotype values.
- **analysis_type = "binary"**: For clearly binary traits (disease/healthy, 
  resistant/susceptible). Converts continuous data using binary_threshold.
- **analysis_type = "logit"**: For proportion data bounded between 0 and 1 
  (survival rates, infection percentages).
- **analysis_type = "arcsine"**: For percentage data with many zeros or ones 
  (germination rates, mortality percentages).
- **analysis_type = "categorical"**: For multi-level categorical traits 
  (flower color, growth habit).
  
**Enhanced Statistical Test Selection:**

- **test_type = "welch_ttest"**: Welch's t-test for continuous normal phenotypes.
  Higher statistical power than non-parametric tests when assumptions are met.
- **test_type = "linear"**: Linear regression, allows inclusion of population
  structure covariates. Provides regression coefficients as effect sizes.
- **test_type = "fisher"**: Best for binary phenotypes, exact p-values, 
  robust with small sample sizes.
- **test_type = "mannwhitney"**: Non-parametric test for continuous phenotypes, 
  no normality assumptions.
- **test_type = "logistic"**: Handles both binary and categorical phenotypes.
  For binary: standard logistic regression. For categorical: multinomial 
  logistic regression (requires nnet package) or chi-square test as fallback.
  Allows inclusion of covariates.

**PAV Feature Filtering Strategy:**

- **min_sample_count**: Removes rare PAV features that may represent sequencing 
  errors or population-specific variants. Higher values increase statistical power 
  but may miss important rare variants.
- **max_sample_count**: Removes ubiquitous PAV features that provide little 
  information. Leave as NULL unless you want to focus on rare variants only.

**Population Structure Correction:**

Principal Component Analysis (PCA) is performed on the PAV matrix to capture 
population structure. The first n_pcs components are included as covariates in 
association tests to control for confounding due to relatedness or population 
stratification.

**PAV Data Types Supported:**

This function can analyze various types of presence/absence variation data:
\itemize{
  \item **K-mer presence/absence**: From k-mer counting tools
  \item **Structural variants**: CNVs, indels, translocations
  \item **Gene presence/absence**: Pan-genome analysis results
  \item **SNP presence/absence**: Binary SNP matrices
  \item **Any binary genomic features**: Regulatory elements, repeat sequences, etc.
}

**Output Files:**

The function creates several output files in the specified directory:
\itemize{
  \item **gwas_results.csv**: Complete association results with chromosomal positions, sequences, p-values and effect sizes
  \item **manhattan_plot.pdf/.png**: Manhattan plot showing associations across chromosomes with multiple significance threshold lines
  \item **significant_p1e-5.csv, significant_p1e-6.csv, etc.**: Separate files for each significance threshold containing only significant features
  \item **significant_fdr0.05.csv**: Features significant after FDR correction
  \item **qq_plot.pdf/.png**: Q-Q plot for test calibration assessment  
  \item **phenotype_distribution.pdf/.png**: Phenotype distribution analysis
  \item **population_structure.pdf/.png**: PCA plots and variance explained
  \item **analysis_summary.txt**: Text summary of results and parameters including threshold-specific counts
}
}
\note{
\itemize{
  \item Requires packages: data.table, dplyr, ggplot2, parallel, corrplot, 
    scales, tidyr, factoextra
  \item Optional packages: nnet (for multinomial logistic regression), 
    moments (for skewness/kurtosis calculation)
  \item Missing data is handled by removing samples with NA values
  \item Multiple testing correction includes both Bonferroni and FDR methods
  \item Large PAV matrices may require substantial memory and processing time
  \item Consider using fewer cores (n_cores) if memory becomes limiting
  \item Both file paths and data frames are accepted as input
  \item Categorical phenotypes: can be numeric (0,1,2) or character ("A","B","C")
  \item Continuous phenotypes: plant height, weight, expression levels, etc.
}
}
\examples{
\dontrun{
# Basic analysis with automatic significance threshold calculation
# PAV matrix format: chr, start, end, sequence, sample1, sample2, ...
result <- pav_gwas(
  pav_data = "pav_matrix.txt",
  phenotype_data = "phenotype_data.txt"
)

# Using data frames as input (common for k-mer analysis)
result <- pav_gwas(
  pav_data = df.pav.matrix,  # Must have chr, start, end, sequence columns
  phenotype_data = df.phenotype,
  output_dir = "my_gwas_results"
)

# Enhanced: Continuous phenotype analysis (e.g., plant height)
result <- pav_gwas(
  pav_data = df.kmer.gwas,
  phenotype_data = df.height.data,  # Continuous height measurements
  analysis_type = "continuous",     # Enhanced continuous analysis
  test_type = "welch_ttest",        # T-test for normal data
  output_dir = "height_gwas_results/"
)

# Enhanced: Auto-detection for continuous phenotypes
result <- pav_gwas(
  pav_data = df.kmer.gwas,
  phenotype_data = df.continuous.phenotype,
  analysis_type = "auto",           # Will auto-detect continuous
  test_type = "auto",               # Will auto-select best test
  use_population_structure = TRUE,   # Include PCA correction
  output_dir = "auto_continuous_gwas/"
)

# Real usage example for structural variants
result <- pav_gwas(
  pav_data = df.kmer.gwas,     # With positional information
  phenotype_data = df.sample.gwas,
  output_dir = "D://OneDrive/NAS/01.科研相关/00.博后/02.data/03.大豆根腐项目/result/01.两个基因变异情况/kmer_gwas/"
)

# Three-class phenotype analysis
result <- pav_gwas(
  pav_data = df.structural.variants,
  phenotype_data = df.three.class.phenotype,  # e.g., "resistant", "intermediate", "susceptible"
  analysis_type = "categorical",
  test_type = "logistic",
  significance_threshold = NULL,  # Auto-calculate
  n_cores = 8
)

# Working with categorical phenotypes (disease resistance levels)
# phenotype data can contain: 0, 1, 2 or "resistant", "intermediate", "susceptible"
result <- pav_gwas(
  pav_data = df.disease.pavs,
  phenotype_data = df.resistance.levels,
  analysis_type = "auto",  # Will auto-detect categorical
  test_type = "auto",      # Will auto-select logistic regression
  output_dir = "disease_resistance_gwas"
)

# Accessing results
print(result$analysis_summary)
head(result$gwas_results)

# View threshold-specific results
print(result$threshold_results)

# Get significant features at different thresholds
significant_1e5 <- result$gwas_results[result$gwas_results$p_value < 1e-5, ]
significant_fdr <- result$gwas_results[result$gwas_results$p_fdr < 0.05, ]

# Threshold-specific files are automatically saved as:
# significant_p1e-5.csv, significant_p1e-6.csv, etc.
}

}
